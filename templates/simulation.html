{% extends "layout.html" %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0">シミュレーション</h1>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newSimulationModal">
    <i class="fas fa-plus fa-sm"></i> 新規シミュレーション作成
  </button>
</div>

<!-- 既存シミュレーション一覧 -->
<div class="card border-0 shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold">保存済みシミュレーション</h6>
  </div>
  <div class="card-body">
    {% if simulations %}
    <div class="table-responsive">
      <table class="table table-bordered" width="100%" cellspacing="0">
        <thead>
          <tr>
            <th>ID</th>
            <th>シミュレーション名</th>
            <th>作成日時</th>
            <th>パラメータ</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for simulation in simulations %}
          <tr>
            <td>{{ simulation.id }}</td>
            <td>{{ simulation.name }}</td>
            <td>{{ simulation.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              <small>
                総エンジニア数: {{ simulation.total_engineers_change }}%<br>
                総製品数: {{ simulation.total_products_change }}%<br>
                年間問い合わせ件数: {{ simulation.annual_inquiries_change }}%<br>
                対応時間: {{ simulation.hours_per_inquiry_change }}%<br>
                製品数上限: {{ simulation.max_products_per_engineer_change }}%<br>
                対応割合: {{ simulation.inquiry_work_ratio_change }}%
              </small>
            </td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-success run-simulation-btn" data-id="{{ simulation.id }}" title="実行">
                <i class="fas fa-play"></i>
              </button>
              <form class="d-inline" action="{{ url_for('delete_simulation', id=simulation.id) }}" method="POST"
                    onsubmit="return confirmDelete(event, 'シミュレーション「{{ simulation.name }}」を削除してもよろしいですか？')">
                <button type="submit" class="btn btn-sm btn-danger" title="削除">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <i class="fas fa-chart-line fa-4x mb-3 text-muted"></i>
      <p>保存済みのシミュレーションはありません。</p>
      <p>「新規シミュレーション作成」ボタンをクリックして、シミュレーションを作成してください。</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- シミュレーション結果表示エリア -->
<div id="simulationResults" class="mb-4" style="display: none;">
  <div class="card border-0 shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold">シミュレーション結果: <span id="simulationResultName"></span></h6>
    </div>
    <div class="card-body">
      <!-- シミュレーションパラメータ -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card border-0 bg-dark">
            <div class="card-header">
              <h6 class="m-0">シミュレーションパラメータ</h6>
            </div>
            <ul class="list-group list-group-flush" id="simulationParams">
              <!-- パラメータはJSで挿入されます -->
            </ul>
          </div>
        </div>
        
        <!-- KPI比較カード -->
        <div class="col-md-8">
          <div class="row">
            <!-- 総エンジニア数 -->
            <div class="col-md-6 mb-3">
              <div class="card border-0 bg-dark h-100" id="currentEngineersCard">
                <div class="card-header">
                  <h6 class="m-0">総エンジニア数</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-6">
                      <div class="text-muted">現在</div>
                      <div class="h4 mb-0 font-weight-bold current-value">0</div>
                    </div>
                    <div class="col-6">
                      <div class="text-muted">シミュレーション後</div>
                      <div class="h4 mb-0 font-weight-bold simulation-value">0</div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <div class="text-muted">変化</div>
                    <div class="h6 mb-0">
                      <i class="change-icon fas fa-minus me-1"></i>
                      <span class="change-value">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 総製品数 -->
            <div class="col-md-6 mb-3">
              <div class="card border-0 bg-dark h-100" id="currentProductsCard">
                <div class="card-header">
                  <h6 class="m-0">総製品数</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-6">
                      <div class="text-muted">現在</div>
                      <div class="h4 mb-0 font-weight-bold current-value">0</div>
                    </div>
                    <div class="col-6">
                      <div class="text-muted">シミュレーション後</div>
                      <div class="h4 mb-0 font-weight-bold simulation-value">0</div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <div class="text-muted">変化</div>
                    <div class="h6 mb-0">
                      <i class="change-icon fas fa-minus me-1"></i>
                      <span class="change-value">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 充足率 -->
            <div class="col-md-6 mb-3">
              <div class="card border-0 bg-dark h-100" id="sufficiencyCard">
                <div class="card-header">
                  <h6 class="m-0">全体の充足率</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-6">
                      <div class="text-muted">現在</div>
                      <div class="h4 mb-0 font-weight-bold current-value">0%</div>
                    </div>
                    <div class="col-6">
                      <div class="text-muted">シミュレーション後</div>
                      <div class="h4 mb-0 font-weight-bold simulation-value">0%</div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <div class="text-muted">変化</div>
                    <div class="h6 mb-0">
                      <i class="change-icon fas fa-minus me-1"></i>
                      <span class="change-value">0%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 平均残業時間 -->
            <div class="col-md-6 mb-3">
              <div class="card border-0 bg-dark h-100" id="overtimeCard">
                <div class="card-header">
                  <h6 class="m-0">平均残業時間</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-6">
                      <div class="text-muted">現在</div>
                      <div class="h4 mb-0 font-weight-bold current-value">0時間/日</div>
                    </div>
                    <div class="col-6">
                      <div class="text-muted">シミュレーション後</div>
                      <div class="h4 mb-0 font-weight-bold simulation-value">0時間/日</div>
                    </div>
                  </div>
                  <div class="mt-3">
                    <div class="text-muted">変化</div>
                    <div class="h6 mb-0">
                      <i class="change-icon fas fa-minus me-1"></i>
                      <span class="change-value">0時間/日</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 製品充足率比較チャート -->
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold">製品充足率の比較</h6>
            </div>
            <div class="card-body">
              <div class="chart-container chart-container-lg">
                <canvas id="sufficiencyComparisonChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- シミュレーションの説明 -->
<div class="card border-0 shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold">シミュレーションとは</h6>
  </div>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h5>シミュレーションで以下のシナリオを検討できます:</h5>
        <ul>
          <li><strong>人員増減の影響</strong>: 総エンジニア数が増減した場合の影響を確認できます。</li>
          <li><strong>製品数変化への対応</strong>: 担当製品数が増減した場合の人員配置の最適化を検討できます。</li>
          <li><strong>問い合わせ対応時間の変化</strong>: 1件あたりの対応時間が変わった場合の影響を確認できます。</li>
          <li><strong>担当製品数上限の調整</strong>: エンジニアあたりの製品数上限を変更した場合の効果を検証できます。</li>
          <li><strong>問い合わせ対応の業務割合</strong>: 総稼働時間に占める問い合わせ対応の割合を調整した場合の影響を確認できます。</li>
        </ul>
        <p class="text-muted">各パラメータはパーセンテージで指定します。たとえば、「+10%」は現在の値より10%増加、「-5%」は5%減少を意味します。</p>
      </div>
      <div class="col-md-4">
        <img src="https://pixabay.com/get/g4fb97443dbc59e4913dd9cb80e4f836ca230ec61ee04a560a63420653c8ee2bf620173629465978fe17321cbc52e2c58270b11041f90f738eab38f9484b01b75_1280.jpg" class="img-fluid rounded" alt="ダッシュボード分析">
      </div>
    </div>
  </div>
</div>

<!-- 新規シミュレーションモーダル -->
<div class="modal fade" id="newSimulationModal" tabindex="-1" aria-labelledby="newSimulationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newSimulationModalLabel">新規シミュレーション作成</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="simulationForm" class="needs-validation" novalidate>
          {{ form.csrf_token }}
          <div class="mb-4">
            <label for="name" class="form-label">シミュレーション名</label>
            <input type="text" class="form-control" id="name" name="name" required placeholder="例: 人員10%増加シナリオ">
            <div class="invalid-feedback">
              シミュレーション名を入力してください。
            </div>
          </div>
          
          <h6 class="mb-3">パラメータ設定</h6>
          <p class="text-muted small mb-3">各パラメータの変化率をパーセントで指定してください（増加: 正の値、減少: 負の値）</p>
          
          <div class="mb-3 simulation-param">
            <label for="total_engineers_change" class="form-label">総エンジニア数の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="total_engineers_change_range" min="-50" max="50" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="total_engineers_change" name="total_engineers_change" value="0">
            </div>
          </div>
          
          <div class="mb-3 simulation-param">
            <label for="total_products_change" class="form-label">総製品数の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="total_products_change_range" min="-50" max="50" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="total_products_change" name="total_products_change" value="0">
            </div>
          </div>

          <div class="mb-3 simulation-param">
            <label for="annual_inquiries_change" class="form-label">年間問い合わせ件数の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="annual_inquiries_change_range" min="-50" max="100" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="annual_inquiries_change" name="annual_inquiries_change" value="0">
            </div>
          </div>
          
          <div class="mb-3 simulation-param">
            <label for="hours_per_inquiry_change" class="form-label">問い合わせあたりの対応時間の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="hours_per_inquiry_change_range" min="-50" max="50" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="hours_per_inquiry_change" name="hours_per_inquiry_change" value="0">
            </div>
          </div>
          
          <div class="mb-3 simulation-param">
            <label for="max_products_per_engineer_change" class="form-label">エンジニアあたり製品数上限の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="max_products_per_engineer_change_range" min="-50" max="50" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="max_products_per_engineer_change" name="max_products_per_engineer_change" value="0">
            </div>
          </div>
          
          <div class="mb-3 simulation-param">
            <label for="inquiry_work_ratio_change" class="form-label">総稼働に対する問い合わせ対応割合の変化率 (%)</label>
            <div class="d-flex align-items-center">
              <input type="range" class="form-range flex-grow-1" id="inquiry_work_ratio_change_range" min="-50" max="50" step="1" value="0">
              <input type="number" class="form-control ms-2" style="width: 80px;" id="inquiry_work_ratio_change" name="inquiry_work_ratio_change" value="0">
            </div>
          </div>
          
          <div class="mt-4">
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" id="runSimulationBtn">シミュレーション実行</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
<script>
  // スライダーと数値入力の連動
  document.addEventListener('DOMContentLoaded', function() {
    const sliders = [
      { range: 'total_engineers_change_range', input: 'total_engineers_change' },
      { range: 'total_products_change_range', input: 'total_products_change' },
      { range: 'annual_inquiries_change_range', input: 'annual_inquiries_change' },
      { range: 'hours_per_inquiry_change_range', input: 'hours_per_inquiry_change' },
      { range: 'max_products_per_engineer_change_range', input: 'max_products_per_engineer_change' },
      { range: 'inquiry_work_ratio_change_range', input: 'inquiry_work_ratio_change' }
    ];
    
    sliders.forEach(function(slider) {
      const rangeElement = document.getElementById(slider.range);
      const inputElement = document.getElementById(slider.input);
      
      if (rangeElement && inputElement) {
        // スライダーの値が変更されたときに入力フィールドを更新
        rangeElement.addEventListener('input', function() {
          inputElement.value = this.value;
        });
        
        // 入力フィールドの値が変更されたときにスライダーを更新
        inputElement.addEventListener('input', function() {
          rangeElement.value = this.value;
        });
      }
    });
  });
</script>
{% endblock %}
